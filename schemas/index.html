<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Internals - Maxwell's Daemon</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../maxwell.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Maxwell's Daemon</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../quickstart/" class="nav-link">Quick Start</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../config/" class="dropdown-item">Reference</a>
</li>
                                    
<li>
    <a href="../deployment/" class="dropdown-item">Deployment</a>
</li>
                                    
<li>
    <a href="../producers/" class="dropdown-item">Producers</a>
</li>
                                    
<li>
    <a href="../filtering/" class="dropdown-item">Filtering</a>
</li>
                                    
<li>
    <a href="../bootstrapping/" class="dropdown-item">Bootstrapping</a>
</li>
                                    
<li>
    <a href="../dataformat/" class="dropdown-item">Data Format</a>
</li>
                                    
<li>
    <a href="../encryption/" class="dropdown-item">Encryption</a>
</li>
                                    
<li>
    <a href="../monitoring/" class="dropdown-item">Monitoring</a>
</li>
                                    
<li>
    <a href="../high_availability/" class="dropdown-item">High Availability</a>
</li>
                                    
<li>
    <a href="../embedding/" class="dropdown-item">Embedding</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Internals</a>
</li>
                                    
<li>
    <a href="../compat/" class="dropdown-item">Compatibility</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../changelog/" class="nav-link">Changelog</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../embedding/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../compat/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
<div class="col-md-4">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#internals" class="nav-link">Internals</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#schema-storage" class="nav-link">Schema storage</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#master-failover" class="nav-link">Master failover</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div>
</div>
<div class="col-md-8" role="main">
    <div id="Internals">
        

<h1 id="internals">Internals</h1>
<h2 id="schema-storage">Schema storage</h2>
<hr />
<p>MySQL binlogs give maxwell access to the raw bytes for each update that happens. In order to generate useful output, Maxwell needs to know the data type of every column, so that it can interpret the bytes as a number, string, boolean, etc.</p>
<p>There is a set of "base schema" tables in the maxwell database - <code>tables</code>, <code>columns</code>, <code>databases</code>. This is where we capture the initial schema, the first time Maxwell is run.</p>
<p>As time progresses, maxwell will see any modifications you make to the schema (these are part of the binlog). As each change occurs, Maxwell will generate an internal representation of what changed. Maxwell stores these diffs in the <code>schemas</code> table - each diff contains the following information to place it in the timeline of your database:</p>
<ul>
<li><code>binlog_file</code>, <code>binlog_position</code> (or <code>gtid_set</code>): the exact point in the binlog stream where the schema change occurred</li>
<li><code>deltas</code>: the internal representation of the schema change</li>
<li><code>base_schema_id</code>: the previous schema that this delta applies to</li>
<li><code>last_heartbeat_read</code>: the most recent maxwell heartbeat seen in the binlog prior to this change</li>
<li><code>server_id</code>: the server which this schema applies to</li>
</ul>
<p>This information creates a concrete timeline of the history of your schema for a given server. Given any binlog file+position (or gtid) and a last_heartbeat value, the current schema can be found by finding the "most recent" schema for this server_id, then following the chain of <code>base_schema_id</code> until it terminates (in a <code>null</code>, which means we've reached the initial captured schema).</p>
<p>"Most recent" should be fairly intuitive - firstly we sort by <code>last_heartbeat_read</code>, then by <code>binlog_file</code>, then <code>binlog_position</code>. We limit the search to values "before" the binlog position we're searching for, because we don't want to use a schema corresponding to a change that is "in the future" - i.e. further ahead in the binlog than our current position.</p>
<h2 id="master-failover">Master failover</h2>
<hr />
<p>Schemas are important for master failover. When Maxwell detects that it is talking to a new <code>server_id</code> (one that differs from its stored <code>position</code>), it attempts a master failover (if enabled). It searches backwards in the new servers binlog files, looking for an update to <code>maxwell.heartbeats</code> corresponding to the timestamp stored in its position table.</p>
<p>Once it finds this (unique) update, it knows the binlog location for both the old and new master which correspond to the exact same event.</p>
<p>Using this information, maxwell creates a merge point - it finds the active schema for the old master's stored position, and then creates a new schema entry with an empty delta, the new <code>server_id</code>, and a base_schema_id of the previous schema. In this way, Maxwell is able to create a chain of schema updates even across different servers with different sets of binlogs.</p>
    </div>
</div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
